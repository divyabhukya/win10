---
- name: Install Prometheus Windows Exporter
  hosts: 10.10.5.182
  gather_facts: no
  tasks:
    - name: Download Prometheus Windows Exporter
      win_get_url:
        url: https://github.com/prometheus-community/windows_exporter/releases/download/v0.23.1/windows_exporter-0.23.1-amd64.msi
        dest: C:\windows_exporter-0.23.1-amd64.msi
      register: download_result

    - name: Create Windows Exporter Service
      win_service:
        name: windows_exporter
        state: present
        service_type: auto
        binary_path: "C:\windows_exporter-0.23.1-amd64.msi --collectors.enabled=default"
      when: download_result.changed

    - name: Start Windows Exporter Service
      win_service:
        name: windows_exporter
        state: started
      when: download_result.changed

    - name: Verify Windows Exporter Service is Running
      win_service:
        name: windows_exporter
        state: started
